<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head lang="en">

    <title>Подписки</title>

    <!--/*/ <th:block th:include="fragments/headerinc :: head"></th:block> /*/-->
    <script src="webjars/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
<div class="container">
    <!--/*/ <th:block th:include="fragments/header :: header"></th:block> /*/-->

    <h2>Детали подписки</h2>
    <div>
        <form id="bookForm" class="form-horizontal" th:value="${ticker}" th:value2="${typeEvent}">

            <div class="form-group">
                <label class="col-sm-2 control-label">Тикер компании:</label>
                <div class="col-sm-10">
                    <input id="tickerInput" type="text" class="form-control"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Тип подписки:</label>
                <div class="col-sm-10">
                    <input id="typeEventInput" type="text" class="form-control"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Id пользователя:</label>
                <div class="col-sm-10">
                    <input id="user_real_idInput" type="text" class="form-control"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Email для оповещения:</label>
                <div class="col-sm-10">
                    <input id="emailInput" type="text" class="form-control"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Telegram для оповещения:</label>
                <div class="col-sm-10">
                    <input id="telegramInput" type="text" class="form-control"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Максимум цены:</label>
                <div class="col-sm-10">
                    <input id="maxInput" type="text" class="form-control"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Минимум цены:</label>
                <div class="col-sm-10">
                    <input id="minInput" type="text" class="form-control"/>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Увеличение цены в процентах:</label>
                <div class="col-sm-10">
                    <input id="changeInput" type="text" class="form-control"/>
                </div>
            </div>

            <div class="row">
                <button type="submit" class="btn btn-default" onclick="saveBook()">Создать подписку</button>
            </div>
        </form>
    </div>


    <script th:inline="javascript">
        const ticker = [[${ticker}]];
        const typeEvent = [[${typeEvent}]];
        console.log(ticker);
        console.log(typeEvent);
        try {
            $(function () {
                $.get('/sub/info/' + ticker + '/' + typeEvent).done(function (bookDto) {
                    console.log(bookDto.typeEvent);
                    console.log(bookDto.ticker);

                    document.getElementById('tickerInput').value = bookDto.ticker;
                    document.getElementById('typeEventInput').value = bookDto.typeEvent;
                    // document.getElementById('user_real_idInput').value = bookDto.authorDto.surname;
                    // document.getElementById('bookGenreInput').value = bookDto.genre.type;
                })
            });
        } catch (e) {
            alert(e);
        }

        var saveBook = function () {
            event.preventDefault();

            const userDto = {
                'user_real_id': document.getElementById("user_real_idInput").value,
                'email': document.getElementById("emailInput").value,
                'telegram': document.getElementById("telegramInput").value,
                'max': document.getElementById("maxInput").value,
                'min': document.getElementById("minInput").value,
                'change': document.getElementById("changeInput").value

            }

            const bookDto = {
                'ticker': document.getElementById("tickerInput").value,
                'typeEvent': document.getElementById("typeEventInput").value,
                'userDto': userDto
            }

            $.ajax({
                url: "/subs",
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(bookDto),
                success: function (newBookId) {
                    document.getElementById("bookForm").reset();
                    window.location.href = "/sub/" + newBookId;
                },
                error: function (jqXHR) {
                    alert(jqXHR.status + ' ' + jqXHR.responseText);
                }
            });
        };

    </script>
</div>
</body>
</html>
